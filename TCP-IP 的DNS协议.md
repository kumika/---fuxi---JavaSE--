# TCP/IP 的DNS协议

如果说ARP协议是用来将IP地址转换为MAC地址，
那么DNS协议则是用来将域名转换为IP地址（也可以将IP地址转换为相应的域名地址）。


TCP/IP中使用的是IP地址和端口号来确定网络上某一台主机上的某一个程序，不免有人有疑问，为什么不用域名来直接进行通信呢？ 

    1. 因为IP地址是固定长度的，IPv4是32位，IPv6是128位，而域名是变长的，不便于计算机处理。 
    2. IP地址对于用户来说不方便记忆，但域名便于用户使用，例如www.baidu.com这是百度的域名。

总结一点就是**IP地址是面向主机的**，而**域名则是面向用户的**。



## hosts文件 

域名和IP的对应关系保存在一个叫hosts文件中。 
最初，通过互联网信息中心来管理这个文件，如果有一个新的计算机想接入网络，或者某个计算IP变更都需要到信息中心申请变更hosts文件。其他计算机也需要定期更新，才能上网。 
但是这样太麻烦了，就出现了DNS系统。



## DNS系统


1. 一个组织的系统管理机构, 维护系统内的每个主机的IP和主机名的对应关系
2. 如果新计算机接入网络，将这个信息注册到数据库中
3. 用户输入域名的时候，会自动查询DNS服务器，由DNS服务器检索数据库，得到对应的IP地址。

---------------------------------------------------------
我们可以通过命令查看自己的hosts文件。

Windows用户查看Hosts文件：

hosts文件，路径是固定的，存储路径：
`c:\windows\system32\drivers\etc\hosts`

Host文件的内容
[![NDS.jpg](https://i.loli.net/2019/02/09/5c5ec17ec8a2c.jpg)](https://i.loli.net/2019/02/09/5c5ec17ec8a2c.jpg)



## DNS域名结构
域名系统必须要保持唯一性。
**域名服务主要是基于UDP实现的**，服务器的端口号为53。 
关于域名的层次结构，如下图所示： 

[![20180529182740527.png](https://i.loli.net/2019/02/15/5c661d6816f88.png)](https://i.loli.net/2019/02/15/5c661d6816f88.png)

eg :我们熟悉的，www.baidu.com 
1. com: 顶级（一级）域名. 表示这是一个企业域名。同级的还有 “net”(网络提供商), “org”(⾮非盈利组织) 等。 
2. baidu: 二级域名，指公司名。 
3. www: 只是一种习惯用法。

个人理解：
www.baidu.com的子域是
www.pan.baidu.com,
www.1231.baidu.com
后面的是一级，从后到前看

|国家顶级域名|	中国:cn， 美国:us，英国uk…|
|----|-----|
 | 通用顶级域名|	com公司企业，edu教育机构，gov政府部门，int国际组织，mil军事部门 ，net网络，org非盈利组织…|



域名服务器
-----

域名是分层结构，域名服务器也是对应的层级结构。 
有了域名结构，还需要有一个东西去解析域名，域名需要由遍及全世界的域名服务器去解析，域名服务器实际上就是装有域名系统的主机。

由高向低进行层次划分，可分为以下几大类：


|分类	|作用|
|----|-----|
|根域名服务器|	最高层次的域名服务器，本地域名服务器解析不了的域名就会向其求助|
|顶级域名服务器| 负责管理在该顶级域名服务器下注册的二级域名|
|权限域名服务器|	负责一个区的域名解析工作|
|本地域名服务器	|当一个主机发出DNS查询请求时，这个查询请求首先发给本地域名服务器|
注：一个域名服务器所负责的范围，或者说有管理权限的范围，就称为区 
我们需要注意的是： 
1. 每个层的域名上都有自己的域名服务器，最顶层的是根域名服务器 
2. 每一级域名服务器都知道下级域名服务器的IP地址 
3. 为了容灾, 每一级至少设置两个或以上的域名服务器



## DNS的解析过程

1.在浏览器中输入www.qq.com域名，**操作系统会先检查自己本地的hosts文件**是否有这个网址映射关系，如果有，就先调用这个IP地址映射，完成域名解析。

2.如果hosts里没有这个域名的映射，则**查找本地DNS解析器缓存**，是否有这个网址映射关系，如果有，直接返回，完成域名解析。


3.如果hosts与本地DNS解析器缓存都没有相应的网址映射关系，首先会找TCP/IP参数中设置的首选DNS服务器，在此我们叫它**本地DNS服务器**，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。


4.如果要查询的域名，不由本地DNS服务器区域解析，但该服务器已缓存了此**网址映射关系**，则调用这个IP地址映射，完成**域名解析**，此解析不具有权威性。


5.如果本地DNS服务器本地区域文件与缓存解析都失效，则根据本地DNS服务器的设置**（是否设置转发器）**进行查询，如果未用转发模式，本地DNS就把请求发至 **“根DNS服务器”**，**“根DNS服务器”**收到请求后会判断这个域名(.com)是谁来授权管理，并会**返回一个负责该顶级域名服务器的一个IP**。**本地DNS服务器**收到IP信息后，将会联系负责.com域的这台服务器。这台负责.com域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com域的下一级DNS服务器地址(qq.com)给本地DNS服务器。当本地DNS服务器收到这个地址后，就会找qq.com域服务器，**重复上面的动作**，进行查询，直至找到www.qq.com主机。

6.如果用的是转发模式，此DNS服务器就会把请求转发至上一级DNS服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根DNS或把转请求转至上上级，以此循环。不管是本地DNS服务器用是是转发，还是根提示，最后都是把结果返回给本地DNS服务器，由此DNS服务器再返回给客户机。

[![20140718112133000.png](https://i.loli.net/2019/02/15/5c6626ab3f97f.png)](https://i.loli.net/2019/02/15/5c6626ab3f97f.png)

[![1126944-20170315222838041-2095036367.jpg](https://i.loli.net/2019/02/15/5c662a622f683.jpg)](https://i.loli.net/2019/02/15/5c662a622f683.jpg)

##使用wireShaker解析

好多数据，暂时看不懂



# 参考：

https://www.cnblogs.com/perfy576/p/8667951.html
https://blog.csdn.net/baidu_37964071/article/details/80500825
https://blog.csdn.net/tianxuhong/article/details/74922454



递归与迭代查询的区别：
https://blog.csdn.net/yanbao4070/article/details/79892032
这2个区别在于回复客户的区别，递归是一问一答，准确的查询结果回复客户，迭代是不直接回复，查到再回复






